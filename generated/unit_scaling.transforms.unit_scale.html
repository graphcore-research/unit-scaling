

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>3.6.8. unit_scaling.transforms.unit_scale &mdash; unit-scaling  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
    <link rel="shortcut icon" href="../_static/scales.png"/>
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="3.6.9. unit_scaling.transforms.Metrics" href="unit_scaling.transforms.Metrics.html" />
    <link rel="prev" title="3.6.7. unit_scaling.transforms.track_scales" href="unit_scaling.transforms.track_scales.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            unit-scaling
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../user_guide.html">1. User guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../limitations.html">2. Limitations</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../api_reference.html">3. API reference</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="unit_scaling.html">3.1. unit_scaling</a></li>
<li class="toctree-l2"><a class="reference internal" href="unit_scaling.analysis.html">3.2. unit_scaling.analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="unit_scaling.constraints.html">3.3. unit_scaling.constraints</a></li>
<li class="toctree-l2"><a class="reference internal" href="unit_scaling.formats.html">3.4. unit_scaling.formats</a></li>
<li class="toctree-l2"><a class="reference internal" href="unit_scaling.functional.html">3.1.22. unit_scaling.functional</a></li>
<li class="toctree-l2"><a class="reference internal" href="unit_scaling.optim.html">3.1.23. unit_scaling.optim</a></li>
<li class="toctree-l2"><a class="reference internal" href="unit_scaling.scale.html">3.5. unit_scaling.scale</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="unit_scaling.transforms.html">3.6. unit_scaling.transforms</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="unit_scaling.transforms.compile.html">3.6.1. unit_scaling.transforms.compile</a></li>
<li class="toctree-l3"><a class="reference internal" href="unit_scaling.transforms.prune_non_float_tensors.html">3.6.2. unit_scaling.transforms.prune_non_float_tensors</a></li>
<li class="toctree-l3"><a class="reference internal" href="unit_scaling.transforms.prune_same_scale_tensors.html">3.6.3. unit_scaling.transforms.prune_same_scale_tensors</a></li>
<li class="toctree-l3"><a class="reference internal" href="unit_scaling.transforms.prune_selected_nodes.html">3.6.4. unit_scaling.transforms.prune_selected_nodes</a></li>
<li class="toctree-l3"><a class="reference internal" href="unit_scaling.transforms.simulate_format.html">3.6.5. unit_scaling.transforms.simulate_format</a></li>
<li class="toctree-l3"><a class="reference internal" href="unit_scaling.transforms.simulate_fp8.html">3.6.6. unit_scaling.transforms.simulate_fp8</a></li>
<li class="toctree-l3"><a class="reference internal" href="unit_scaling.transforms.track_scales.html">3.6.7. unit_scaling.transforms.track_scales</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">3.6.8. unit_scaling.transforms.unit_scale</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#unit_scaling.transforms.unit_scale"><code class="docutils literal notranslate"><span class="pre">unit_scale()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="unit_scaling.transforms.Metrics.html">3.6.9. unit_scaling.transforms.Metrics</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="unit_scaling.transforms.utils.html">3.7. unit_scaling.transforms.utils</a></li>
<li class="toctree-l2"><a class="reference internal" href="unit_scaling.utils.html">3.8. unit_scaling.utils</a></li>
<li class="toctree-l2"><a class="reference internal" href="unit_scaling.core.functional.html">3.1.21.1. unit_scaling.core.functional</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">unit-scaling</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../api_reference.html"><span class="section-number">3. </span>API reference</a></li>
          <li class="breadcrumb-item"><a href="unit_scaling.transforms.html"><span class="section-number">3.6. </span>unit_scaling.transforms</a></li>
      <li class="breadcrumb-item active"><span class="section-number">3.6.8. </span>unit_scaling.transforms.unit_scale</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/generated/unit_scaling.transforms.unit_scale.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="unit-scaling-transforms-unit-scale">
<h1><span class="section-number">3.6.8. </span>unit_scaling.transforms.unit_scale<a class="headerlink" href="#unit-scaling-transforms-unit-scale" title="Link to this heading"></a></h1>
<dl class="py function">
<dt class="sig sig-object py" id="unit_scaling.transforms.unit_scale">
<span class="sig-prename descclassname"><span class="pre">unit_scaling.transforms.</span></span><span class="sig-name descname"><span class="pre">unit_scale</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">module</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">M</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">replace</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Dict" title="(in Python v3.13)"><span class="pre">Dict</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Callable" title="(in Python v3.13)"><span class="pre">Callable</span></a><span class="p"><span class="pre">[</span></span><span class="p"><span class="pre">[</span></span><span class="p"><span class="pre">...</span></span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Any" title="(in Python v3.13)"><span class="pre">Any</span></a><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Callable" title="(in Python v3.13)"><span class="pre">Callable</span></a><span class="p"><span class="pre">[</span></span><span class="p"><span class="pre">[</span></span><span class="p"><span class="pre">...</span></span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Any" title="(in Python v3.13)"><span class="pre">Any</span></a><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">]</span></span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">{}</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">M</span></span></span><a class="reference internal" href="../_modules/unit_scaling/transforms/_unit_scale.html#unit_scale"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#unit_scaling.transforms.unit_scale" title="Link to this definition"></a></dt>
<dd><p><strong>[Experimental]</strong> Returns a unit-scaled version of the input model.</p>
<p>Uses TorchDynamo to trace and transform the user-supplied module.
This transformation identifies all <code class="xref py py-class docutils literal notranslate"><span class="pre">torch.nn.functional</span></code> uses in the input
module, and replaces them with their unit-scaled equivalents, should they exist.</p>
<p>The tracing procedure automatically recurses into modules
(whether defined in libraries, or by the user), identifying inner calls to any
<code class="xref py py-class docutils literal notranslate"><span class="pre">torch.nn.functional</span></code> operations, to build a graph of fundamental operations.
Unit scaling is then applied as a transformation on top of this graph.</p>
<p>This transformation proceeds in five stages:</p>
<ol class="arabic simple">
<li><p><strong>Replacement of user-defined functions</strong> according to the supplied <cite>replace</cite>
dictionary.</p></li>
<li><p><strong>Replacement of all functions with unit-scaled equivalents</strong> defined in
<a class="reference internal" href="unit_scaling.functional.html#module-unit_scaling.functional" title="unit_scaling.functional"><code class="xref py py-mod docutils literal notranslate"><span class="pre">unit_scaling.functional</span></code></a>.</p></li>
<li><p>Identification &amp; <strong>replacement of all add operations that represent
residual-adds</strong>. The identification of residual connections is done via a
dependency analysis on the graph. Residual-adds require special scaling compared
with regular adds (see paper / User Guide for details).</p></li>
<li><p><strong>Unconstraining of all operations after the final residual layer</strong>. By default
all unit scaled operations have their scaling factors constrained in the forward
and backward pass to give valid gradients. This is not required in these final
layers (see paper for proof), and hence we can unconstrain the operations to give
better scaling.</p></li>
<li><p><strong>Unit-scaling of all weights</strong> and zero-initialisation of all biases.</p></li>
</ol>
<p>Note that by using TorchDynamo, <cite>unit_scale()</cite> is able to trace a much larger set of
modules / operations than with previous PyTorch tracing approaches. This enables
the process of unit scaling to be expressed as a generic graph transform that can be
applied to arbitrary modules.</p>
<p>Note that the current version of TorchDynamo (or <a class="reference external" href="https://pytorch.org/docs/stable/generated/torch.compile.html#torch.compile" title="(in PyTorch v2.5)"><code class="xref py py-func docutils literal notranslate"><span class="pre">torch.compile()</span></code></a>, which is a
wrapper around TorchDynamo) doesn’t support nested transforms, so we implement our
own system here. This makes it easy to nest transforms:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">unit_scaling.transforms</span> <span class="kn">import</span> <span class="nb">compile</span><span class="p">,</span> <span class="n">simulate_fp8</span><span class="p">,</span> <span class="n">unit_scale</span>

<span class="n">module</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">simulate_fp8</span><span class="p">(</span><span class="n">unit_scale</span><span class="p">(</span><span class="n">module</span><span class="p">)))</span>
</pre></div>
</div>
<p>However, these transforms are not interoperable with the standard
<a class="reference external" href="https://pytorch.org/docs/stable/generated/torch.compile.html#torch.compile" title="(in PyTorch v2.5)"><code class="xref py py-func docutils literal notranslate"><span class="pre">torch.compile()</span></code></a> interface.</p>
<p>In some cases users may have a model definition that uses a custom implementation of
a basic operation. In this case, <cite>unit_scale()</cite> can be told explicitly to substitute
the layer for an equivalent, using the <cite>replace</cite> dictionary:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">unit_scaling.functional</span> <span class="k">as</span> <span class="nn">U</span>
<span class="kn">from</span> <span class="nn">unit_scaling.transforms</span> <span class="kn">import</span> <span class="n">unit_scale</span>

<span class="k">def</span> <span class="nf">new_gelu</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="o">...</span>

<span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="o">...</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">new_gelu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="o">...</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">unit_scale</span><span class="p">(</span><span class="n">Model</span><span class="p">(),</span> <span class="n">replace</span><span class="o">=</span><span class="p">{</span><span class="n">new_gelu</span><span class="p">:</span> <span class="n">U</span><span class="o">.</span><span class="n">gelu</span><span class="p">})</span>
</pre></div>
</div>
<p>This can also be used to substitute a particular function for a user-defined
unit-scaled function not provided by <a class="reference internal" href="unit_scaling.functional.html#module-unit_scaling.functional" title="unit_scaling.functional"><code class="xref py py-mod docutils literal notranslate"><span class="pre">unit_scaling.functional</span></code></a>.</p>
<p><strong>Note:</strong> <cite>unit_scale()</cite> is experimental and has not yet been widely tested on a
range of models. The standard approach to unit scaling a model is still to
manually substitute the layers/operations in a model with their unit-scaled
equivalents. Having said this, <cite>unit_scale()</cite> is implemented in a sufficiently
generic way that we anticipate many users will ultimately be able to rely on this
graph transform alone.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>module</strong> (<em>nn.Module</em>) – the input module to be unit scaled.</p></li>
<li><p><strong>replace</strong> (<em>Dict</em><em>[</em><em>Callable</em><em>, </em><em>Callable</em><em>]</em><em>, </em><em>optional</em>) – a dictionary where keys represent
functions to be replaced by the corresponding value-functions. Note that
these substitutions take priority over the standard unit scaling
substitutions. Defaults to dict().</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>the unit scaled module (with an independent copy of parameters)</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>nn.Module</p>
</dd>
</dl>
</dd></dl>

</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="unit_scaling.transforms.track_scales.html" class="btn btn-neutral float-left" title="3.6.7. unit_scaling.transforms.track_scales" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="unit_scaling.transforms.Metrics.html" class="btn btn-neutral float-right" title="3.6.9. unit_scaling.transforms.Metrics" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright (c) 2023 Graphcore Ltd. All rights reserved.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>